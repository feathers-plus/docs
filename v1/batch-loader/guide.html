


<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <title>Guide — Feathers-Plus</title>
    <meta charset="utf-8">
    <meta name="description" content="Feathers-Plus - Bridging FeathersJS and real world apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="alternate" hreflang="x-default" href="https://vuejs.org/v1/batch-loader/guide.html">
    <link rel="alternate" hreflang="zh" href="https://cn.vuejs.org/v1/batch-loader/guide.html">
    <link rel="alternate" hreflang="ja" href="https://jp.vuejs.org/v1/batch-loader/guide.html">
    <link rel="alternate" hreflang="ru" href="https://ru.vuejs.org/v1/batch-loader/guide.html">
    <link rel="alternate" hreflang="ko" href="https://kr.vuejs.org/v1/batch-loader/guide.html">
    <link rel="alternate" hreflang="pt-BR" href="https://br.vuejs.org/v1/batch-loader/guide.html">
    <link rel="alternate" hreflang="fr" href="https://fr.vuejs.org/v1/batch-loader/guide.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Guide — Feathers-Plus">
    <meta property="og:description" content="Feathers-Plus - Bridging FeathersJS and real world apps.">
    <meta property="og:image" content="https://feathers-plus.com//images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Guide — Feathers-Plus">
    <meta name="twitter:description" content="Feathers-Plus - Bridging FeathersJS and real world apps.">
    <meta name="twitter:image" content="https://feathers-plus.com/images/logo.png">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons//apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/icons//apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons//apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons//apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons//apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons//apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons//apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons//apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons//apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icons//android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icons//favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons//favicon-16x16.png">
    <link rel="manifest" href="/images/icons//manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js" rel="stylesheet" type="text/css">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles ------------------------------------------------------------------------->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts ------------------------------------>
    <script src="/js/client-bundle.js"></script>
    <script>window.PAGE_TYPE = "guide"</script>

    <!-- ga --------------------------------------------------------------------------------------->
    <!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-xxxxxxxx-1', 'feathers-plus.com');
      ga('send', 'pageview');
    </script>
    --->
  </head>
  <body class="docs">
    <div id="mobile-bar">
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>

    <!-- top nav bar ------------------------------------------------------------------------------>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png">
    <span>Feathers-Plus</span>
  </a>
  <ul id="nav">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Extensions</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/feathers-hooks-common/" class="nav-link">feathers-hooks-common</a></li>
        <li><a href="/v1/authentication-management/" class="nav-link">authentication-management</a></li>
      </ul>
    </li>
    <li><h4>Batch Loader</h4></li>
    <li>
      <ul>
        <li><a href="/v1/batch-loader/" class="nav-link current">batch-loader</a></li>
        <li><a href="/v1/cache" class="nav-link">cache</a></li>
      </ul>
    </li>
    <li><h4>Offline First</h4></li>
    <li>
      <ul>
        <li><a href="/v1/offline-snapshot/" class="nav-link">offline-snapshot</a></li>
        <li><a href="/v1/offline-realtime/" class="nav-link">offline-realtime</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Adapters</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/graphql/" class="nav-link">graphql</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container support-vue">
  <a class="nav-link">Frameworks</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="https://vuex.feathersjs.com" target="_blank" class="nav-link">feathers-vuex</a></li>
      </ul>
    </li>
  </ul>
</li>


  </ul>
</div>


    <!-- body ------------------------------------------------------------------------------------->
    
      <div id="main" class="fix-sidebar">
        
          <!--  documentation page ---------------------------------------------------------------->
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
        <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Extensions</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/feathers-hooks-common/" class="nav-link">feathers-hooks-common</a></li>
        <li><a href="/v1/authentication-management/" class="nav-link">authentication-management</a></li>
      </ul>
    </li>
    <li><h4>Batch Loader</h4></li>
    <li>
      <ul>
        <li><a href="/v1/batch-loader/" class="nav-link current">batch-loader</a></li>
        <li><a href="/v1/cache" class="nav-link">cache</a></li>
      </ul>
    </li>
    <li><h4>Offline First</h4></li>
    <li>
      <ul>
        <li><a href="/v1/offline-snapshot/" class="nav-link">offline-snapshot</a></li>
        <li><a href="/v1/offline-realtime/" class="nav-link">offline-realtime</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Adapters</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/graphql/" class="nav-link">graphql</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container support-vue">
  <a class="nav-link">Frameworks</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="https://vuex.feathersjs.com" target="_blank" class="nav-link">feathers-vuex</a></li>
      </ul>
    </li>
  </ul>
</li>


    </ul>
    <div class="list">
      <h3>batch-loader
        <select class="version-select">
          <option value="SELF" selected>1.0</option>
        </select></h3>
        <ul class="menu-root">
  
    
    <li>
      <a href="/v1/batch-loader/guide.html" class="sidebar-link current">Guide</a>
    </li>
  
    
    <li>
      <a href="/v1/batch-loader/index.html" class="sidebar-link">API</a>
    </li>
  
    
    <li>
      <a href="/v1/batch-loader/common-patterns.html" class="sidebar-link">Common Patterns</a>
    </li>
  
</ul>

    </div>
  </div>
</div>


<div class="content guide with-sidebar guide-guide">
  
    

    
  
  
    <h1>Guide</h1>
  
  <p>Loading data from database is one of the major tasks for most web applications. The goal of batch-loader is to improve the performance of database queries with two techniques: batching and caching.</p>
<h2 id="Batching"><a href="#Batching" class="headerlink" title="Batching"></a>Batching</h2><p>Batching is batch-loader’s primary feature. The reason for batching is to merge multiple similar database queries into one single query when possible. For example:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  posts.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125; &#125; ),</span><br><span class="line">  posts.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: <span class="number">2</span> &#125; &#125; ),</span><br><span class="line">  posts.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: &#123; <span class="attr">$in</span>: [<span class="number">3</span>, <span class="number">4</span>] &#125; &#125; &#125; ),</span><br><span class="line">  posts.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: <span class="number">5</span> &#125; &#125; )</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>is slower than</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">posts.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: &#123; <span class="attr">$in</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125; &#125; &#125; )</span><br></pre></td></tr></table></figure>
<p>The latter sends only one query to database and retrieves the same 5 records as the former does, and therefore is much more efficient.</p>
<p>Batch-loader is a tool to help you batch database calls in such a way. First, create a batch-loader by providing a batch loading function which accepts an array of keys and an optional context. It returns a Promise which resolves to an array of values.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> usersLoader = <span class="keyword">new</span> BatchLoader(<span class="function">(<span class="params">keys, context</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> app.service(<span class="string">'users'</span>).find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: &#123; <span class="attr">$in</span>: keys &#125; &#125; &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">records</span> =&gt;</span> &#123;</span><br><span class="line">      recordsByKey = <span class="comment">/* recordsByKey[i] is the value for key[i] */</span>;</span><br><span class="line">      <span class="keyword">return</span> recordsByKey;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">context</span>: &#123;&#125; &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>You can then call the batch-loader with individual keys. It will coalesce all requests made within the current event loop into a single call to the batch-loader function, and return the results to each call.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">usersLoader.load(<span class="number">1</span>).then(<span class="function"><span class="params">user</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'key 1'</span>, user));</span><br><span class="line">usersLoader.load(<span class="number">2</span>).then(<span class="function"><span class="params">user</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'key 2'</span>, user));</span><br><span class="line">usersLoader.loadMany([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]).then(<span class="function"><span class="params">users</span> =&gt;</span> <span class="built_in">console</span>.log(users.length, users));</span><br></pre></td></tr></table></figure>
<p>The above will result in one database service call, i.e. <code>users.find({ query: { id: { $in: [1, 2, 3, 4] } } })</code>, instead of 6.</p>
<p class="tip"><em>“[W]ill coalesce all requests made within the current event loop into a single call”</em> sounds ominous. Just don’t worry about it. Make <code>usersLoader.load</code> and <code>usersLoader.loadMany</code> calls the same way you would <code>users.get</code> and <code>users.find</code>. Everything will work as expected while, behind the scenes, batch-loader is making the fewest database calls logically possible.</p>

<h3 id="Batch-Function"><a href="#Batch-Function" class="headerlink" title="Batch Function"></a>Batch Function</h3><p>The batch loading function accepts an array of keys and an optional context. It returns a Promise which resolves to an array of values. Each index in the returned array of values must correspond to the same index in the array of keys.</p>
<p>For example, if the <code>usersLoader</code> from above is called with <code>[1, 2, 3, 4, 99]</code>, we would execute <code>users.find({ query: { id: { $in: [1, 2, 3, 4, 99] } } })</code>. The Feathers service could return the results:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[ &#123; <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">name</span>: <span class="string">'Aubree'</span> &#125;</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">'Barbara'</span> &#125; ]</span><br></pre></td></tr></table></figure>
<p>Please not that the order of the results will usually differ from the order of the keys and here, in addition, there is no <code>users</code> with an <code>id</code> of <code>99</code>.</p>
<p>The batch function has to to reorganize the above results and return:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[ &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">'Barbara'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">name</span>: <span class="string">'Aubree'</span> &#125;,</span><br><span class="line">  <span class="literal">null</span> ]</span><br></pre></td></tr></table></figure>
<p>The <code>null</code> indicating there is no record for <code>user.id === 99</code>.</p>
<h3 id="Convenience-Methods"><a href="#Convenience-Methods" class="headerlink" title="Convenience Methods"></a>Convenience Methods</h3><p>Batch-loader provides two convenience functions that will perform this reorganization for you.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getResultsByKey, getUniqueKeys &#125; = BatchLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> usersLoader = <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">keys</span> =&gt;</span></span><br><span class="line">  app.service(<span class="string">'users'</span>).find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: &#123; <span class="attr">$in</span>: getUniqueKeys(keys) &#125; &#125; &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">records</span> =&gt;</span> getResultsByKey(keys, records, user =&gt; user.id, <span class="string">''</span>));</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><strong>getUniqueKeys</strong> eliminates any duplicate elements in the keys.</p>
<blockquote>
<p>The array of keys may contain duplicates when the batch-loader’s memoization cache is disabled.</p>
</blockquote>
<p><strong>getResultsByKey</strong> reorganizes the records from the service call into the result expected from the batch function. The <code>&#39;&#39;</code> parameter indicates each key expects a single record or <code>null</code>. Other options are <code>&#39;!&#39;</code> when each key requires a single record, and <code>&#39;[]&#39;</code> when each key requires an array of 0, 1 or more records.</p>
<h2 id="Caching"><a href="#Caching" class="headerlink" title="Caching"></a>Caching</h2><p>Each batch-loader instance contains a unique memoized cache. Once <code>load</code> or <code>loadMany</code> is called, the resulting value is cached. This eliminates redundant database requests, relieving pressure on your database. It also creates fewer objects which may relieve memory pressure on your application.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  userLoader.load(<span class="number">1</span>),</span><br><span class="line">  userLoader.load(<span class="number">1</span>)</span><br><span class="line">])</span><br><span class="line">  .then(<span class="function"><span class="params">users</span> =&gt;</span> assert(users[<span class="number">0</span>] === users[<span class="number">1</span>]));</span><br></pre></td></tr></table></figure>
<p class="tip">The same object is returned for each of multiple hits on the cache. You should not mutate that object directly as the mutation would be reflected in every reference to the object. Rather you should deep-copy before mutating the copy.</p>

<h3 id="Caching-Per-Request"><a href="#Caching-Per-Request" class="headerlink" title="Caching Per Request"></a>Caching Per Request</h3><p>It may be dangerous to use one cache across many users, and it is encouraged to create a new batch-loader per request. Typically batch-loader instances are created when a request begins and are released once the request ends.</p>
<p>Since the cache exists for a limited time only, the cache contents should not normally grow large enough to cause memory pressure on the application.</p>
<h3 id="Persistent-Caches"><a href="#Persistent-Caches" class="headerlink" title="Persistent Caches"></a>Persistent Caches</h3><p>A batch-loader can be shared between requests and between users if care is taken. Use caution when used in long-lived applications or those which serve many users with different access permissions.</p>
<p>The main advantage is having the cache already primed at the start of each request, which could result in fewer initial database requests.</p>
<h4 id="Memory-pressure"><a href="#Memory-pressure" class="headerlink" title="Memory pressure"></a>Memory pressure</h4><p>There are two concerns though. First the cache could keep filling up with records causing memory pressure. This can be handled with a custom cache.</p>
<p><strong>@feathers-plus/cache</strong> is a least-recently-used (LRU) cache which you can inject when initializing the batch-loader. You can specify the maximum number of records to be kept in the cache, and it will retain the least recently used records.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> cache = <span class="built_in">require</span>(<span class="string">'@feathers-plus/cache'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> usersLoader = <span class="keyword">new</span> BatchLoader(</span><br><span class="line">  keys =&gt; &#123; ... &#125;,</span><br><span class="line">  &#123; <span class="attr">cacheMap</span>: cache(&#123; <span class="attr">max</span>: <span class="number">100</span> &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h4><p>The other concern is a record mutating. You can create a hook which clears a record from its BatchLoaders’ caches when it mutates.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">usersLoader.clear(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>@feathers-plus/cache/lib/hooks</code> contains hooks which clear the keys of mutated records.</p>
</blockquote>
<h2 id="Explore-Performance-Gains"><a href="#Explore-Performance-Gains" class="headerlink" title="Explore Performance Gains"></a>Explore Performance Gains</h2><h3 id="Our-Sample-Data"><a href="#Our-Sample-Data" class="headerlink" title="Our Sample Data"></a>Our Sample Data</h3><p>We will be using Feathers database services containing the following data:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.service('posts')</span></span><br><span class="line"><span class="keyword">const</span> postsStore = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">body</span>: <span class="string">'John post'</span>, <span class="attr">userId</span>: <span class="number">101</span>, <span class="attr">starIds</span>: [<span class="number">102</span>, <span class="number">103</span>, <span class="number">104</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">body</span>: <span class="string">'Marshall post'</span>, <span class="attr">userId</span>: <span class="number">102</span>, <span class="attr">starIds</span>: [<span class="number">101</span>, <span class="number">103</span>, <span class="number">104</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">body</span>: <span class="string">'Barbara post'</span>, <span class="attr">userId</span>: <span class="number">103</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">body</span>: <span class="string">'Aubree post'</span>, <span class="attr">userId</span>: <span class="number">104</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.service('comments')</span></span><br><span class="line"><span class="keyword">const</span> commentsStore = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">11</span>, <span class="attr">text</span>: <span class="string">'John post Marshall comment 11'</span>, <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">12</span>, <span class="attr">text</span>: <span class="string">'John post Marshall comment 12'</span>, <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">13</span>, <span class="attr">text</span>: <span class="string">'John post Marshall comment 13'</span>, <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">14</span>, <span class="attr">text</span>: <span class="string">'Marshall post John comment 14'</span>, <span class="attr">postId</span>: <span class="number">2</span>, <span class="attr">userId</span>: <span class="number">101</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">15</span>, <span class="attr">text</span>: <span class="string">'Marshall post John comment 15'</span>, <span class="attr">postId</span>: <span class="number">2</span>, <span class="attr">userId</span>: <span class="number">101</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">16</span>, <span class="attr">text</span>: <span class="string">'Barbara post John comment 16'</span>, <span class="attr">postId</span>: <span class="number">3</span>, <span class="attr">userId</span>: <span class="number">101</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">17</span>, <span class="attr">text</span>: <span class="string">'Aubree post Marshall comment 17'</span>, <span class="attr">postId</span>: <span class="number">4</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.service('users')</span></span><br><span class="line"><span class="keyword">const</span> usersStore = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">101</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">103</span>, <span class="attr">name</span>: <span class="string">'Barbara'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">104</span>, <span class="attr">name</span>: <span class="string">'Aubree'</span> &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>We want to see how using batch-loader affects the number of database calls, and we will do that by populating the <code>posts</code> records with related information.</p>
<h3 id="Using-Plain-JavaScript"><a href="#Using-Plain-JavaScript" class="headerlink" title="Using Plain JavaScript"></a>Using Plain JavaScript</h3><p>First, let’s add the related <code>comments</code> records to each <code>posts</code> record using regular JavaScript, and let’s do this using both Promises and async/await.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Populate using Promises.</span></span><br><span class="line"><span class="built_in">Promise</span>.resolve(posts.find()</span><br><span class="line">  .then(<span class="function"><span class="params">posts</span> =&gt;</span> <span class="built_in">Promise</span>.all(posts.map(<span class="function"><span class="params">post</span> =&gt;</span> comments.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">postId</span>: post.id &#125; &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">      post.commentRecords = comments;</span><br><span class="line">      <span class="keyword">return</span> post;</span><br><span class="line">    &#125;)</span><br><span class="line">  )))</span><br><span class="line">)</span><br><span class="line">  .then(<span class="function"><span class="params">data</span> =&gt;</span> ... );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Populate using async/await.</span></span><br><span class="line"><span class="keyword">const</span> postRecords = <span class="keyword">await</span> posts.find();</span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(postRecords.map(<span class="keyword">async</span> post =&gt; &#123;</span><br><span class="line">  post.commentRecords = <span class="keyword">await</span> comments.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">postId</span>: post.id &#125; &#125;);</span><br><span class="line">  <span class="keyword">return</span> post;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>Both of these make the following database service calls, and both get the following result.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">... posts find</span><br><span class="line">... comments find &#123; <span class="attr">postId</span>: <span class="number">1</span> &#125;</span><br><span class="line">... comments find &#123; <span class="attr">postId</span>: <span class="number">2</span> &#125;</span><br><span class="line">... comments find &#123; <span class="attr">postId</span>: <span class="number">3</span> &#125;</span><br><span class="line">... comments find &#123; <span class="attr">postId</span>: <span class="number">4</span> &#125;</span><br><span class="line"></span><br><span class="line">[ &#123; <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    body: <span class="string">'John post'</span>,</span><br><span class="line">    userId: <span class="number">101</span>,</span><br><span class="line">    starIds: [ <span class="number">102</span>, <span class="number">103</span>, <span class="number">104</span> ],</span><br><span class="line">    commentRecords: [</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">11</span>, <span class="attr">text</span>: <span class="string">'John post Marshall comment 11'</span>, <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">12</span>, <span class="attr">text</span>: <span class="string">'John post Marshall comment 12'</span>, <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">id</span>: <span class="number">13</span>, <span class="attr">text</span>: <span class="string">'John post Marshall comment 13'</span>, <span class="attr">postId</span>: <span class="number">1</span>, <span class="attr">userId</span>: <span class="number">102</span> &#125; ] &#125;,</span><br><span class="line">  &#123; ... &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="Using-Neither-Batching-nor-Caching"><a href="#Using-Neither-Batching-nor-Caching" class="headerlink" title="Using Neither Batching nor Caching"></a>Using Neither Batching nor Caching</h3><p>The batch-loader function will be called for every <code>load</code> and <code>loadMany</code> when batching and caching are disabled in the batch-loader. This means it acts just like individual <code>get</code> and <code>find</code> method calls. Let’s rewrite the above example using such a rudimentary batch-loader:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getResultsByKey, getUniqueKeys &#125; = BatchLoader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Populate using Promises.</span></span><br><span class="line"><span class="keyword">const</span> commentsLoaderPromises = <span class="keyword">new</span> BatchLoader(</span><br><span class="line">  keys =&gt; comments.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">postId</span>: &#123; <span class="attr">$in</span>: getUniqueKeys(keys) &#125; &#125; &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> getResultsByKey(keys, result, comment =&gt; comment.postId, <span class="string">'[]'</span>)),</span><br><span class="line">  &#123; <span class="attr">batch</span>: <span class="literal">false</span>, <span class="attr">cache</span>: <span class="literal">false</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(posts.find()</span><br><span class="line">  .then(<span class="function"><span class="params">postRecords</span> =&gt;</span> <span class="built_in">Promise</span>.all(postRecords.map(<span class="function"><span class="params">post</span> =&gt;</span> commentsLoaderPromises.load(post.id)</span><br><span class="line">    .then(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">      post.commentRecords = comments;</span><br><span class="line">      <span class="keyword">return</span> post;</span><br><span class="line">    &#125;)</span><br><span class="line">  )))</span><br><span class="line">)</span><br><span class="line">  .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123; ... &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Populate using async/await.</span></span><br><span class="line"><span class="keyword">const</span> commentsLoaderAwait = <span class="keyword">new</span> BatchLoader(<span class="keyword">async</span> keys =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> postRecords = <span class="keyword">await</span> comments.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">postId</span>: &#123; <span class="attr">$in</span>: getUniqueKeys(keys) &#125; &#125; &#125;);</span><br><span class="line">    <span class="keyword">return</span> getResultsByKey(keys, postRecords, comment =&gt; comment.postId, <span class="string">'[]'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">batch</span>: <span class="literal">false</span>, <span class="attr">cache</span>: <span class="literal">false</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postRecords = <span class="keyword">await</span> posts.find();</span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(postRecords.map(<span class="keyword">async</span> post =&gt; &#123;</span><br><span class="line">  post.commentRecords = <span class="keyword">await</span> commentsLoaderAwait.load(post.id);</span><br><span class="line">  <span class="keyword">return</span> post;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>Both of these make the same database service calls as did the <a href="#Using-Plain-JavaScript">plain JavaScript example</a>, because batching and caching were both disabled.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">... posts find</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 1 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 2 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 3 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 4 ] &#125; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>A batch-loader with neither batching nor caching makes the same database calls as does a plain Javascript implementation. This is a convenient way to debug issues you might have with batch-loader. The <em>“magic”</em> disappears when you disable batching and caching, which makes it simpler to understand what is happening.</p>
</blockquote>
<h3 id="Using-Batching-and-Caching"><a href="#Using-Batching-and-Caching" class="headerlink" title="Using Batching and Caching"></a>Using Batching and Caching</h3><p>Batching and caching are enabled when we remove the 2 <code>{ batch: false, cache: false }</code> in the above example. A very different performance profile is now produced:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">... posts find</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 1, 2, 3, 4 ] &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>Only 1 service call was made for the <code>comments</code> records, instead of the previous 4.</p>
<h3 id="A-Realistic-Example"><a href="#A-Realistic-Example" class="headerlink" title="A Realistic Example"></a>A Realistic Example</h3><p>The more service calls made, the better batch-loader performs. The above example populated the <code>posts</code> records with just the <code>comments</code> records. Let’s see the effect batch-loader has when we fully populate the <code>posts</code> records.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; map, parallel &#125; = <span class="built_in">require</span>(<span class="string">'asyncro'</span>);</span><br><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; getResultsByKey, getUniqueKeys &#125; = BatchLoader;</span><br><span class="line"></span><br><span class="line">tester(&#123; <span class="attr">batch</span>: <span class="literal">false</span>, <span class="attr">cache</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123; ... )</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">tester</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> commentsLoader = <span class="keyword">new</span> BatchLoader(<span class="keyword">async</span> keys =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> comments.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">postId</span>: &#123; <span class="attr">$in</span>: getUniqueKeys(keys) &#125; &#125; &#125;);</span><br><span class="line">      <span class="keyword">return</span> getResultsByKey(keys, result, comment =&gt; comment.postId, <span class="string">'[]'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    options</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> usersLoader = <span class="keyword">new</span> BatchLoader(<span class="keyword">async</span> keys =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> users.find(&#123; <span class="attr">query</span>: &#123; <span class="attr">id</span>: &#123; <span class="attr">$in</span>: getUniqueKeys(keys) &#125; &#125; &#125;);</span><br><span class="line">      <span class="keyword">return</span> getResultsByKey(keys, result, user =&gt; user.id, <span class="string">''</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    options</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> postRecords = <span class="keyword">await</span> posts.find();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> map(postRecords, <span class="keyword">async</span> post =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> parallel([</span><br><span class="line">      <span class="comment">// Join one users record to posts, for post.userId === users.id</span></span><br><span class="line">      <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        post.userRecord = <span class="keyword">await</span> usersLoader.load(post.userId);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Join 0, 1 or many comments records to posts, where comments.postId === posts.id</span></span><br><span class="line">      <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> commentRecords = <span class="keyword">await</span> commentsLoader.load(post.id);</span><br><span class="line">        post.commentRecords = commentRecords;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Join one users record to comments, for comments.userId === users.id</span></span><br><span class="line">        <span class="keyword">await</span> map(commentRecords, <span class="keyword">async</span> comment =&gt; &#123;</span><br><span class="line">          comment.userRecord = <span class="keyword">await</span> usersLoader.load(comment.userId);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Join 0, 1 or many users record to posts, where posts.starIds === users.id</span></span><br><span class="line">      <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!post.starIds) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        post.starUserRecords = <span class="keyword">await</span> usersLoader.loadMany(post.starIds);</span><br><span class="line">      &#125;</span><br><span class="line">    ]);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> postRecords;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice <code>usersLoader</code> is being called within 3 quite different joins. These joins will share their batching and cache, noticeably improving overall performance.</p>
</blockquote>
<p>This example has batching and caching disabled. These 22 service calls are made when it is run. They are the same calls which a plain JavaScript implementation would have made:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">... posts find</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 101 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 1 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 102 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 103 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 104 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 102 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 2 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 101 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 103 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 104 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 103 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 3 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 104 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 4 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 102 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 102 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 102 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 101 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 101 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 101 ] &#125; &#125;</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 102 ] &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>Now let’s enable batching and caching by changing <code>tester({ batch: false, cache: false })</code> to <code>tester()</code>. Only these <strong>three</strong> service calls are now made to obtain the same results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">... posts find</span><br><span class="line">... users find &#123; id: &#123; &apos;$in&apos;: [ 101, 102, 103, 104 ] &#125; &#125;</span><br><span class="line">... comments find &#123; postId: &#123; &apos;$in&apos;: [ 1, 2, 3, 4 ] &#125; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The 2 BatchLoaders reduced the number of services calls from 22 for a plain implementation, to just 3!</p>
</blockquote>
<p>The final populated result is:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[ &#123; <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    body: <span class="string">'John post'</span>,</span><br><span class="line">    userId: <span class="number">101</span>,</span><br><span class="line">    starIds: [ <span class="number">102</span>, <span class="number">103</span>, <span class="number">104</span> ],</span><br><span class="line">    userRecord: &#123; <span class="attr">id</span>: <span class="number">101</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125;,</span><br><span class="line">    starUserRecords:</span><br><span class="line">     [ &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">103</span>, <span class="attr">name</span>: <span class="string">'Barbara'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">104</span>, <span class="attr">name</span>: <span class="string">'Aubree'</span> &#125; ],</span><br><span class="line">    commentRecords:</span><br><span class="line">     [ &#123; <span class="attr">id</span>: <span class="number">11</span>,</span><br><span class="line">         text: <span class="string">'John post Marshall comment 11'</span>,</span><br><span class="line">         postId: <span class="number">1</span>,</span><br><span class="line">         userId: <span class="number">102</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125; &#125;,</span><br><span class="line">       &#123; <span class="attr">id</span>: <span class="number">12</span>,</span><br><span class="line">         text: <span class="string">'John post Marshall comment 12'</span>,</span><br><span class="line">         postId: <span class="number">1</span>,</span><br><span class="line">         userId: <span class="number">102</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125; &#125;,</span><br><span class="line">       &#123; <span class="attr">id</span>: <span class="number">13</span>,</span><br><span class="line">         text: <span class="string">'John post Marshall comment 13'</span>,</span><br><span class="line">         postId: <span class="number">1</span>,</span><br><span class="line">         userId: <span class="number">102</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125; &#125; ] &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">    body: <span class="string">'Marshall post'</span>,</span><br><span class="line">    userId: <span class="number">102</span>,</span><br><span class="line">    starIds: [ <span class="number">101</span>, <span class="number">103</span>, <span class="number">104</span> ],</span><br><span class="line">    userRecord: &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125;,</span><br><span class="line">    starUserRecords:</span><br><span class="line">     [ &#123; <span class="attr">id</span>: <span class="number">101</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">103</span>, <span class="attr">name</span>: <span class="string">'Barbara'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">104</span>, <span class="attr">name</span>: <span class="string">'Aubree'</span> &#125; ],</span><br><span class="line">    commentRecords:</span><br><span class="line">     [ &#123; <span class="attr">id</span>: <span class="number">14</span>,</span><br><span class="line">         text: <span class="string">'Marshall post John comment 14'</span>,</span><br><span class="line">         postId: <span class="number">2</span>,</span><br><span class="line">         userId: <span class="number">101</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">101</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125; &#125;,</span><br><span class="line">       &#123; <span class="attr">id</span>: <span class="number">15</span>,</span><br><span class="line">         text: <span class="string">'Marshall post John comment 15'</span>,</span><br><span class="line">         postId: <span class="number">2</span>,</span><br><span class="line">         userId: <span class="number">101</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">101</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125; &#125; ] &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">    body: <span class="string">'Barbara post'</span>,</span><br><span class="line">    userId: <span class="number">103</span>,</span><br><span class="line">    userRecord: &#123; <span class="attr">id</span>: <span class="number">103</span>, <span class="attr">name</span>: <span class="string">'Barbara'</span> &#125;,</span><br><span class="line">    commentRecords:</span><br><span class="line">     [ &#123; <span class="attr">id</span>: <span class="number">16</span>,</span><br><span class="line">         text: <span class="string">'Barbara post John comment 16'</span>,</span><br><span class="line">         postId: <span class="number">3</span>,</span><br><span class="line">         userId: <span class="number">101</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">101</span>, <span class="attr">name</span>: <span class="string">'John'</span> &#125; &#125; ] &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">4</span>,</span><br><span class="line">    body: <span class="string">'Aubree post'</span>,</span><br><span class="line">    userId: <span class="number">104</span>,</span><br><span class="line">    userRecord: &#123; <span class="attr">id</span>: <span class="number">104</span>, <span class="attr">name</span>: <span class="string">'Aubree'</span> &#125;,</span><br><span class="line">    commentRecords:</span><br><span class="line">     [ &#123; <span class="attr">id</span>: <span class="number">17</span>,</span><br><span class="line">         text: <span class="string">'Aubree post Marshall comment 17'</span>,</span><br><span class="line">         postId: <span class="number">4</span>,</span><br><span class="line">         userId: <span class="number">102</span>,</span><br><span class="line">         userRecord: &#123; <span class="attr">id</span>: <span class="number">102</span>, <span class="attr">name</span>: <span class="string">'Marshall'</span> &#125; &#125; ] &#125; ]</span><br></pre></td></tr></table></figure>
<h2 id="See-also"><a href="#See-also" class="headerlink" title="See also"></a>See also</h2><ul>
<li><a href="https://github.com/facebook/dataloader" target="_blank" rel="noopener">facebook/dataloader</a> from which batch-loader is derived.</li>
</ul>

  
    <div class="guide-links">
      <!-- link to previous page -->
      
      <!-- link to next page -->
      
        <span style="float: right;"><a href="/v1/batch-loader/index.html">API</a> →</span>
      
    </div>
  
  <div class="footer">

    Caught a mistake or want to contribute to the documentation?
    <a href="https://github.com/feathers-plus/docs/blob/master/source/v1/batch-loader/guide.md" target="_blank">
      Edit this page on Github!
    </a>
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. ------------------------------------>
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- search ----------------------------------------------------------------------------------->
    <!--
    <link href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/search.css">
    <script src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '85cc3221c9f23bfbaa4e3913dd7625ea',
      indexName: 'vuejs',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] }
      })
    })
    </script>
    -->

    <!-- fastclick -------------------------------------------------------------------------------->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
