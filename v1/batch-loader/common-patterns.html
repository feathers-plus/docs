


<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <title>Common Patterns — Feathers-Plus</title>
    <meta charset="utf-8">
    <meta name="description" content="Feathers-Plus - Bridging FeathersJS and real world apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="alternate" hreflang="x-default" href="https://vuejs.org/v1/batch-loader/common-patterns.html">
    <link rel="alternate" hreflang="zh" href="https://cn.vuejs.org/v1/batch-loader/common-patterns.html">
    <link rel="alternate" hreflang="ja" href="https://jp.vuejs.org/v1/batch-loader/common-patterns.html">
    <link rel="alternate" hreflang="ru" href="https://ru.vuejs.org/v1/batch-loader/common-patterns.html">
    <link rel="alternate" hreflang="ko" href="https://kr.vuejs.org/v1/batch-loader/common-patterns.html">
    <link rel="alternate" hreflang="pt-BR" href="https://br.vuejs.org/v1/batch-loader/common-patterns.html">
    <link rel="alternate" hreflang="fr" href="https://fr.vuejs.org/v1/batch-loader/common-patterns.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Common Patterns — Feathers-Plus">
    <meta property="og:description" content="Feathers-Plus - Bridging FeathersJS and real world apps.">
    <meta property="og:image" content="https://feathers-plus.com//images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Common Patterns — Feathers-Plus">
    <meta name="twitter:description" content="Feathers-Plus - Bridging FeathersJS and real world apps.">
    <meta name="twitter:image" content="https://feathers-plus.com/images/logo.png">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons//apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/icons//apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons//apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons//apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons//apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons//apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons//apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons//apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons//apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icons//android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icons//favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons//favicon-16x16.png">
    <link rel="manifest" href="/images/icons//manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js" rel="stylesheet" type="text/css">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles ------------------------------------------------------------------------->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts ------------------------------------>
    <script src="/js/client-bundle.js"></script>
    <script>window.PAGE_TYPE = "guide"</script>

    <!-- ga --------------------------------------------------------------------------------------->
    <!--
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-xxxxxxxx-1', 'feathers-plus.com');
      ga('send', 'pageview');
    </script>
    --->
  </head>
  <body class="docs">
    <div id="mobile-bar">
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>

    <!-- top nav bar ------------------------------------------------------------------------------>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png">
    <span>Feathers-Plus</span>
  </a>
  <ul id="nav">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Extensions</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/feathers-hooks-common/" class="nav-link">feathers-hooks-common</a></li>
        <li><a href="/v1/authentication-management/" class="nav-link">authentication-management</a></li>
      </ul>
    </li>
    <li><h4>Batch Loader</h4></li>
    <li>
      <ul>
        <li><a href="/v1/batch-loader/" class="nav-link current">batch-loader</a></li>
        <li><a href="/v1/cache" class="nav-link">cache</a></li>
      </ul>
    </li>
    <li><h4>Offline First</h4></li>
    <li>
      <ul>
        <li><a href="/v1/offline-snapshot/" class="nav-link">offline-snapshot</a></li>
        <li><a href="/v1/offline-realtime/" class="nav-link">offline-realtime</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Adapters</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/graphql/" class="nav-link">graphql</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container support-vue">
  <a class="nav-link">Frameworks</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="https://vuex.feathersjs.com" target="_blank" class="nav-link">feathers-vuex</a></li>
      </ul>
    </li>
  </ul>
</li>


  </ul>
</div>


    <!-- body ------------------------------------------------------------------------------------->
    
      <div id="main" class="fix-sidebar">
        
          <!--  documentation page ---------------------------------------------------------------->
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
        <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Extensions</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/feathers-hooks-common/" class="nav-link">feathers-hooks-common</a></li>
        <li><a href="/v1/authentication-management/" class="nav-link">authentication-management</a></li>
      </ul>
    </li>
    <li><h4>Batch Loader</h4></li>
    <li>
      <ul>
        <li><a href="/v1/batch-loader/" class="nav-link current">batch-loader</a></li>
        <li><a href="/v1/cache" class="nav-link">cache</a></li>
      </ul>
    </li>
    <li><h4>Offline First</h4></li>
    <li>
      <ul>
        <li><a href="/v1/offline-snapshot/" class="nav-link">offline-snapshot</a></li>
        <li><a href="/v1/offline-realtime/" class="nav-link">offline-realtime</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Adapters</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/v1/graphql/" class="nav-link">graphql</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container support-vue">
  <a class="nav-link">Frameworks</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="https://vuex.feathersjs.com" target="_blank" class="nav-link">feathers-vuex</a></li>
      </ul>
    </li>
  </ul>
</li>


    </ul>
    <div class="list">
      <h3>batch-loader
        <select class="version-select">
          <option value="SELF" selected>1.0</option>
        </select></h3>
        <ul class="menu-root">
  
    
    <li>
      <a href="/v1/batch-loader/guide.html" class="sidebar-link">Guide</a>
    </li>
  
    
    <li>
      <a href="/v1/batch-loader/index.html" class="sidebar-link">API</a>
    </li>
  
    
    <li>
      <a href="/v1/batch-loader/common-patterns.html" class="sidebar-link current">Common Patterns</a>
    </li>
  
</ul>

    </div>
  </div>
</div>


<div class="content guide with-sidebar common-patterns-guide">
  
    

    
  
  
    <h1>Common Patterns</h1>
  
  <h2 id="Creating-a-new-batch-loader-per-Request"><a href="#Creating-a-new-batch-loader-per-Request" class="headerlink" title="Creating a new batch-loader per Request."></a>Creating a new batch-loader per Request.</h2><p>In many applications, a server using batch-loader serves requests to many different users with different access permissions. It may be dangerous to use one cache across many users, and it is encouraged to create a new batch-loader per request:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createLoaders</span>(<span class="params">authToken</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    users: <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">ids</span> =&gt;</span> genUsers(authToken, ids)),</span><br><span class="line">    cdnUrls: <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">rawUrls</span> =&gt;</span> genCdnUrls(authToken, rawUrls)),</span><br><span class="line">    stories: <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">keys</span> =&gt;</span> genStories(authToken, keys)),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When handling an incoming request:</span></span><br><span class="line"><span class="keyword">var</span> loaders = createLoaders(request.query.authToken);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Then, within application logic:</span></span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">await</span> loaders.users.load(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">var</span> pic = <span class="keyword">await</span> loaders.cdnUrls.load(user.rawPicUrl);</span><br></pre></td></tr></table></figure>
<h2 id="Loading-by-alternative-keys"><a href="#Loading-by-alternative-keys" class="headerlink" title="Loading by alternative keys."></a>Loading by alternative keys.</h2><p>Occasionally, some kind of value can be accessed in multiple ways. For example, perhaps a “User” type can be loaded not only by an “id” but also by a “username” value. If the same user is loaded by both keys, then it may be useful to fill both caches when a user is loaded from either source:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> userByIDLoader = <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">ids</span> =&gt;</span> genUsersByID(ids).then(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> user <span class="keyword">of</span> users) &#123;</span><br><span class="line">    usernameLoader.prime(user.username, user);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> users;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> usernameLoader = <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">names</span> =&gt;</span> genUsernames(names).then(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> user <span class="keyword">of</span> users) &#123;</span><br><span class="line">    userByIDLoader.prime(user.id, user);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> users;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<h2 id="Persistent-caches"><a href="#Persistent-caches" class="headerlink" title="Persistent caches"></a>Persistent caches</h2><p>By default, batch-loader uses the standard Map which simply grows until the batch-loader is released. A custom cache is provided as a convenience if you want to persist caches for longer periods of time. It implements a <strong>least-recently-used</strong> algorithm and allows you to limit the number of records cached.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> cache = <span class="built_in">require</span>(<span class="string">'@feathers-plus/cache'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> usersLoader = <span class="keyword">new</span> BatchLoader(</span><br><span class="line">  keys =&gt; &#123; ... &#125;,</span><br><span class="line">  &#123; <span class="attr">cacheMap</span>: cache(&#123; <span class="attr">max</span>: <span class="number">100</span> &#125;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p class="tip">The default cache is appropriate when requests to your application are short-lived.</p>

<h2 id="Using-non-Feathers-services"><a href="#Using-non-Feathers-services" class="headerlink" title="Using non-Feathers services"></a>Using non-Feathers services</h2><p>batch-loader provides a simplified and consistent API over various data sources, when its used as part of your application’s data fetching layer. Custom Feathers services can use batch-loaders to natively accesses local and remote resources.</p>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>Redis is a very simple key-value store which provides the batch load method MGET which makes it very well suited for use with batch-loader.<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> redis = <span class="built_in">require</span>(<span class="string">'redis'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = redis.createClient();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> redisLoader = <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">keys</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  client.mget(keys, (error, results) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">return</span> reject(error);</span><br><span class="line"></span><br><span class="line">    resolve(results.map(<span class="function">(<span class="params">result, index</span>) =&gt;</span></span><br><span class="line">      result !== <span class="literal">null</span> ? result : <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`No key: <span class="subst">$&#123;keys[index]&#125;</span>`</span>)</span><br><span class="line">    ));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<h3 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h3><p>While not a key-value store, SQL offers a natural batch mechanism with SELECT * WHERE IN statements. While batch-loader is best suited for key-value stores, it is still suited for SQL when queries remain simple. This example requests the entire row at a given id, however your usage may differ.</p>
<p>This example uses the sqlite3 client which offers a parallelize method to further batch queries together. Another non-caching batch-loader utilizes this method to provide a similar API. batch-loaders can access other batch-loaders.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> sqlite3 = <span class="built_in">require</span>(<span class="string">'sqlite3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = <span class="keyword">new</span> sqlite3.Database(<span class="string">'./to/your/db.sql'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dispatch a WHERE-IN query, ensuring response has rows in correct order.</span></span><br><span class="line"><span class="keyword">const</span> userLoader = <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">ids</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> params = ids.map(<span class="function"><span class="params">id</span> =&gt;</span> <span class="string">'?'</span> ).join();</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`SELECT * FROM users WHERE id IN (<span class="subst">$&#123;params&#125;</span>)`</span>;</span><br><span class="line">  <span class="keyword">return</span> queryLoader.load([query, ids]).then(</span><br><span class="line">    rows =&gt; ids.map(</span><br><span class="line">      id =&gt; rows.find(<span class="function"><span class="params">row</span> =&gt;</span> row.id === id) || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Row not found: <span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parallelize all queries, but do not cache.</span></span><br><span class="line"><span class="keyword">const</span> queryLoader = <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">queries</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> waitingOn = queries.length;</span><br><span class="line">  <span class="keyword">const</span> results = [];</span><br><span class="line">  db.parallelize(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    queries.forEach(<span class="function">(<span class="params">query, index</span>) =&gt;</span> &#123;</span><br><span class="line">      db.all.apply(db, query.concat(<span class="function">(<span class="params">error, result</span>) =&gt;</span> &#123;</span><br><span class="line">        results[index] = error || result;</span><br><span class="line">        <span class="keyword">if</span> (--waitingOn === <span class="number">0</span>) &#123;</span><br><span class="line">          resolve(results);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;), &#123; <span class="attr">cache</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> promise1 = userLoader.load(<span class="string">'1234'</span>);</span><br><span class="line"><span class="keyword">const</span> promise2 = userLoader.load(<span class="string">'5678'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([ promise1, promise2 ]).then(<span class="function">(<span class="params">[ user1, user2]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(user1, user2);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Knex-js"><a href="#Knex-js" class="headerlink" title="Knex.js"></a>Knex.js</h3><p>This example demonstrates how to use batch-loader with SQL databases via Knex.js, which is a SQL query builder and a client for popular databases such as PostgreSQL, MySQL, MariaDB etc.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'./db'</span>); <span class="comment">// an instance of Knex client</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The list of batch loaders</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> batchLoader = &#123;</span><br><span class="line">  user: <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">ids</span> =&gt;</span> db.table(<span class="string">'users'</span>)</span><br><span class="line">    .whereIn(<span class="string">'id'</span>, ids).select()</span><br><span class="line">    .then(<span class="function"><span class="params">rows</span> =&gt;</span> ids.map(<span class="function"><span class="params">id</span> =&gt;</span> rows.find(<span class="function"><span class="params">x</span> =&gt;</span> x.id === id)))),</span><br><span class="line"></span><br><span class="line">  story: <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">ids</span> =&gt;</span> db.table(<span class="string">'stories'</span>)</span><br><span class="line">    .whereIn(<span class="string">'id'</span>, ids).select()</span><br><span class="line">    .then(<span class="function"><span class="params">rows</span> =&gt;</span> ids.map(<span class="function"><span class="params">id</span> =&gt;</span> rows.find(<span class="function"><span class="params">x</span> =&gt;</span> x.id === id)))),</span><br><span class="line"></span><br><span class="line">  storiesByUserId: <span class="keyword">new</span> BatchLoader(<span class="function"><span class="params">ids</span> =&gt;</span> db.table(<span class="string">'stories'</span>)</span><br><span class="line">    .whereIn(<span class="string">'author_id'</span>, ids).select()</span><br><span class="line">    .then(<span class="function"><span class="params">rows</span> =&gt;</span> ids.map(<span class="function"><span class="params">id</span> =&gt;</span> rows.filter(<span class="function"><span class="params">x</span> =&gt;</span> x.author_id === id)))),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  batchLoader.user.load(<span class="string">'1234'</span>),</span><br><span class="line">  batchLoader.storiesByUserId.load(<span class="string">'1234'</span>),</span><br><span class="line">]).then(<span class="function">(<span class="params">[user, stories]</span>) =&gt;</span> &#123;<span class="comment">/* ... */</span>&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="RethinkDB"><a href="#RethinkDB" class="headerlink" title="RethinkDB"></a>RethinkDB</h3><p>Full implementation:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BatchLoader = <span class="built_in">require</span>(<span class="string">'@feathers-plus/batch-loader'</span>);</span><br><span class="line"><span class="keyword">const</span> r = <span class="built_in">require</span>(<span class="string">'rethinkdb'</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="keyword">await</span> r.connect();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> batchLoadFunc = <span class="function"><span class="params">keys</span> =&gt;</span> db.table(<span class="string">'example_table'</span>)</span><br><span class="line">  .getAll(...keys)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> res.toArray())</span><br><span class="line">  .then(normalizeRethinkDbResults(keys, <span class="string">'id'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> exampleLoader = <span class="keyword">new</span> BatchLoader(batchLoadFunc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> exampleLoader.loadMany([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// [&#123;"id": 1, "name": "Document 1"&#125;, &#123;"id": 2, "name": "Document 2"&#125;, Error];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> exampleLoader.load(<span class="number">1</span>); <span class="comment">// &#123;"id": 1, "name": "Document 1"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">indexResults</span>(<span class="params">results, indexField, cacheKeyFn = key =&gt; key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> indexedResults = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  results.forEach(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    indexedResults.set(cacheKeyFn(res[indexField]), res);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> indexedResults;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeRethinkDbResults</span>(<span class="params">keys, indexField, cacheKeyFn = key =&gt; key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> indexedResults = indexResults(results, indexField, cacheKeyFn);</span><br><span class="line">    <span class="keyword">return</span> keys.map(<span class="function"><span class="params">val</span> =&gt;</span> indexedResults.get(cacheKeyFn(val)) || <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Key not found : <span class="subst">$&#123;val&#125;</span>`</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  
    <div class="guide-links">
      <!-- link to previous page -->
      
        <span>← <a href="/v1/batch-loader/index.html">API</a></span>
      
      <!-- link to next page -->
      
    </div>
  
  <div class="footer">

    Caught a mistake or want to contribute to the documentation?
    <a href="https://github.com/feathers-plus/docs/blob/master/source/v1/batch-loader/common-patterns.md" target="_blank">
      Edit this page on Github!
    </a>
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. ------------------------------------>
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- search ----------------------------------------------------------------------------------->
    <!--
    <link href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/search.css">
    <script src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '85cc3221c9f23bfbaa4e3913dd7625ea',
      indexName: 'vuejs',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] }
      })
    })
    </script>
    -->

    <!-- fastclick -------------------------------------------------------------------------------->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
